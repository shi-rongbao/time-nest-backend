<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shirongbao.timenest.dao.ChatSessionsDao">

    <!-- 自定义结果映射 -->
    <resultMap id="ChatSessionVOMap" type="com.shirongbao.timenest.pojo.vo.ChatSessionVo">
        <id property="sessionId" column="id"/>
        <result property="sessionType" column="session_type"/>
        <result property="lastMessageContent" column="last_message_content"/>
        <result property="lastMessageTime" column="last_message_time"/>
        <result property="unreadCount" column="unread_count"/>
    </resultMap>

    <!-- 分页查询用户的会话列表 -->
    <select id="selectSessionVOPage" resultMap="ChatSessionVOMap">
        SELECT
            s.id,
            s.session_type,
            s.group_name,
            s.group_avatar,
            s.last_message_content,
            s.last_message_time,
            sm.unread_count,
            (
                SELECT message_type 
                FROM chat_messages 
                WHERE session_id = s.id 
                ORDER BY id DESC 
                LIMIT 1
            ) as message_type,
            (
                SELECT sender_id 
                FROM chat_messages 
                WHERE session_id = s.id 
                ORDER BY id DESC 
                LIMIT 1
            ) as sender_id,
            (
                SELECT u.nick_name 
                FROM chat_messages cm
                JOIN users u ON cm.sender_id = u.id
                WHERE cm.session_id = s.id 
                ORDER BY cm.id DESC 
                LIMIT 1
            ) as sender_name
        FROM
            chat_sessions s
        INNER JOIN
            chat_session_members sm ON s.id = sm.session_id AND sm.user_id = #{userId}
        WHERE
            s.is_deleted = 0
            <if test="sessionType != null">
                AND s.session_type = #{sessionType}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (
                    /* 群聊名称搜索 */
                    (s.session_type = 2 AND s.group_name LIKE CONCAT('%', #{keyword}, '%'))
                    OR
                    /* 单聊对方用户昵称搜索 */
                    (s.session_type = 1 AND EXISTS (
                        SELECT 1
                        FROM chat_session_members sm2
                        JOIN users u ON sm2.user_id = u.id
                        WHERE sm2.session_id = s.id
                          AND sm2.user_id != #{userId}
                          AND u.nick_name LIKE CONCAT('%', #{keyword}, '%')
                    ))
                )
            </if>
        ORDER BY
            s.last_message_time DESC
    </select>
    
    <!-- 批量查询会话中的对方用户信息 -->
    <select id="selectTargetUsersBySessionIds" resultType="java.util.Map">
        SELECT 
            sm.session_id,
            u.id as user_id,
            u.nick_name,
            u.avatar_url
        FROM 
            chat_session_members sm
        JOIN 
            users u ON sm.user_id = u.id
        WHERE 
            sm.session_id IN 
            <foreach item="id" collection="sessionIds" open="(" separator="," close=")">
                #{id}
            </foreach>
            AND sm.user_id != #{userId}
            AND EXISTS (
                SELECT 1 FROM chat_sessions s 
                WHERE s.id = sm.session_id AND s.session_type = 1
            )
    </select>
</mapper>